import colorsRaw from 'material-colors'
import { mkdirSync, writeFileSync } from 'node:fs'
import { runScript } from './utils/script-helper'
import { toShortHex } from './utils/css-helper'
import { dirname, join } from 'node:path'
import { toPascalCase } from '../src/utils/stringManipulation'
import { isAccessible } from '../src/utils/wcag'

const specialColors: ColorName[] = ['white', 'black']

/**
 * Generate TS file
 */

const flatColors: Record<string, string> = {}

Object.entries(colorsRaw).forEach(([colorName, shades]) => {
	if (typeof shades === 'object') {
		Object.entries(shades as object).forEach(([shade, value]) => {
			// Only use numeric shades, skip non-numeric (like "A100") if you want or keep all keys
			if (!Number.isNaN(Number(shade))) {
				const key = `${colorName}-${shade}`
				flatColors[key] = value as string
			}
		})
	} else if (typeof shades === 'string') {
		flatColors[colorName] = shades
	}
})

const colorNames: string[] = Object.keys(flatColors)
	.map((color) => color.split('-')[0])
	.reduce((result: string[], current) => {
		if (!result.includes(current)) {
			result.push(current)
		}
		return result
	}, [])

const tsContent = `/**
 * --------------------------------------------------------------------
 * THIS FILE IS AUTO-GENERATED — DO NOT EDIT IT DIRECTLY!
 *
 * This file was generated by the generate-colors script.
 * Any manual changes will be overwritten.
 * --------------------------------------------------------------------
 */

/**
 * array for all possible colors names
*/
export const colorNames = \n${JSON.stringify(colorNames, null, 2)} as const

/**
 * array for all possible colors
*/
export const colors = \n${JSON.stringify(
	Object.keys(flatColors)
		.map((color) => color.replace('-', ''))
		.filter(
			(color) =>
				!specialColors.includes(color) && colorNames.some((name) => color.startsWith(name)),
		),
	null,
	2,
)} as const

/**
 * type that define all colors available for components
*/
export type Color = typeof colors[number]

/**
 * object of all possible color values
*/
export const colorsFlat = ${JSON.stringify(flatColors, null, 2)}
`

writeFileSync('src/assets/typescript/colors.ts', tsContent)

console.log('✅ colors.ts generated')

runScript('npx prettier --write src/assets/typescript/colors.ts')

/**
 * Generate CSS file
 */

// CSS colors
const cssVarsArr: string[] = []

Object.entries(flatColors).forEach(([colorName, value]) => {
	cssVarsArr.push(`\t--neo-color-${colorName.replace('-', '')}: ${toShortHex(value)};`)
})

const cssVars = cssVarsArr.join('\n')

// WCAG Accessibility backgrounds
const accessibilityClasses: string[] = []

Object.entries(flatColors).forEach(([colorName, value]) => {
	const bg = toShortHex(value)

	// Check against black & white only (most robust)
	if (isAccessible(bg, '#000000')) {
		accessibilityClasses.push(
			`.Themed--${colorName.replace('-', '')} { --neo-theme-background: var(--neo-color-${colorName.replace('-', '')}); --neo-theme-color: var(--neo-color-black); }`,
		)
	}
	if (isAccessible(bg, '#ffffff')) {
		accessibilityClasses.push(
			`.Themed--${colorName.replace('-', '')} { --neo-theme-background: var(--neo-color-${colorName.replace('-', '')}); --neo-theme-color: var(--neo-color-white); }`,
		)
	}
})

writeFileSync(
	'./src/assets/styles/colors.css',
	`/**
 * --------------------------------------------------------------------
 * THIS FILE IS AUTO-GENERATED — DO NOT EDIT IT DIRECTLY!
 *
 * This file was generated by the generate-colors script.
 * Any manual changes will be overwritten.
 *
 * To update this file, run the appropriate generation script.
 * --------------------------------------------------------------------
 */
\n:root {
${cssVars}
}

/* Accessible background utilities */
${accessibilityClasses.join('\n')}
`,
)

console.log('✅ colors.css generated')

runScript('npx prettier --write src/assets/styles/colors.css')

/**
 * Generate MD documentation
 */

const mdRowsArr: string[] = []

Object.entries(colorsRaw).forEach(([colorName, shades]) => {
	if (typeof shades === 'object') {
		Object.entries(shades as object)
			.filter(([shade]) => !Number.isNaN(Number(shade)))
			.forEach(([shade]) => {
				mdRowsArr.push(`| ${colorName} | ${shade} | \`--neo-color-${colorName}${shade}\` |`)
			})
	} else if (typeof shades === 'string') {
		mdRowsArr.push(`| ${colorName} | - | \`--neo-color-${colorName.replace('-', '')}\` |`)
	}
})

const mdHeader = `# Material Colors

> Auto-generated documentation of available CSS variables for colors.

| Color | Shade | CSS Variable |
|-------|-------|--------------|
`

const mdContent = `${mdHeader}${mdRowsArr.join('\n')}\n`

const mdFilePath = join(process.cwd(), 'docs/colors.md')
mkdirSync(dirname(mdFilePath), { recursive: true })
writeFileSync(mdFilePath, mdContent)
console.log('✅ Colors.md generated')

/**
 * Generate MDX file out of MD content
 */

const lines = mdContent.split('\n').filter((line) => line.trim().startsWith('|')) // skip header & separator
const rows = lines.slice(2) // skip table header + --- separator

type ColorName = (typeof colorNames)[number]

const dataByColorName: Record<ColorName | 'special', string[]> = Object.fromEntries(
	[...colorNames, 'special'].map((c) => [c, []]),
) as Record<ColorName, string[]>

// Build MDX table rows
rows.forEach((line) => {
	const data = line
		.split('|')
		.map((c) => c.trim())
		.filter((value) => value)

	let name = data[0]
	const value = data[2]

	if (specialColors.includes(name)) {
		name = 'special'
	}

	dataByColorName[name].push(`
			<tr>
				<td>${value}</td>
				<td>
					<div style={{
						display: 'flex',
						justifyContent: 'center',
						alignItems: 'center',

						inlineSize: '4rem',
						blockSize: '4rem',
						margin: 'auto',

						backgroundColor: \`var(${value.replace(/`/g, '')})\`,
						border: '1px solid #ccc'
					}}/>
				</td>
			</tr>
		`)
})

const tables = Object.entries(dataByColorName)
	.filter(([colorName, tableData]) => tableData.length && !specialColors.includes(colorName))
	.map(
		([color, tableData]) => `
<div style={{inlineSize: '100%'}}>
	<h2>${toPascalCase(color)}</h2>
	<table style={{inlineSize: '100%'}}>
		<thead>
			<tr>
				<th>Name</th>
				<th>Preview</th>
			</tr>
		</thead>
		<tbody>
			${tableData.join('')}
		</tbody>
	</table>
</div>
`,
	)

const mdxContent = `
import { Meta, Title, Subtitle } from '@storybook/blocks'

<Meta title="Foundation/Colors" />

<Title>Colors</Title>

{/**
 * --------------------------------------------------------------------
 * THIS FILE IS AUTO-GENERATED — DO NOT EDIT IT DIRECTLY!
 *
 * This file was generated by the generate-colors script.
 * Any manual changes will be overwritten.
 *
 * To update this file, run the appropriate generation script.
 * The script is automatically triggered by the pre-flight script
 * --------------------------------------------------------------------
 */}

<div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)'}}>
	${tables.join('').replace(/\<\/table\>\n,/g, '<\/table\>')}
</div>
`

mkdirSync('./src/components/00-foundations', { recursive: true })
writeFileSync(`./src/components/00-foundations/colors.mdx`, mdxContent)
console.log(`✅ Storybook MDX generated`)
